name: Build and Deploy API

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      # Configuración del agente SSH para conexión segura
      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Agregar host a known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      # Copiar archivos necesarios al servidor
      - name: Copiar archivos de proyecto
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'mkdir -p /var/www/toros-api.salazarcode.net'
          rsync -avz --delete ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/var/www/toros-api.salazarcode.net/

      # Construir y desplegar Docker
      - name: Build y Deploy Docker
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
            cd /var/www/toros-api.salazarcode.net &&
            docker build -t toros-api . &&
            docker stop toros-api || true &&
            docker rm toros-api || true &&
            docker run -d \
              --name toros-api \
              --network eventmanager_network \
              -p 5000:80 \
              -e ASPNETCORE_ENVIRONMENT=Production \
              --restart always \
              toros-api
          '

      # Limpiar imágenes antiguas (opcional)
      - name: Limpiar imágenes antiguas
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'docker system prune -f'
